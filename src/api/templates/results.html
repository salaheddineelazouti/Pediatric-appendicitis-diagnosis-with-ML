{% extends "base.html" %}

{% block title %}Results - Pediatric Appendicitis Diagnosis Support{% endblock %}

{% block extra_css %}
<style>
    /* Progress bar colors */
    .positive-contrib {
        background-color: #28a745;  /* Green for positive contributions */
    }
    .negative-contrib {
        background-color: #dc3545;  /* Red for negative contributions */
    }
    
    /* Feature contribution styling */
    .feature-contribution {
        margin-bottom: 12px;
    }
    .feature-value {
        color: #6c757d;
    }
    
    /* Progress bar height */
    .progress {
        height: 20px !important;
        background-color: #e9ecef;
    }
    
    /* Print styles */
    @media print {
        .print-hide {
            display: none !important;
        }
        .card {
            border: 1px solid #ddd !important;
            break-inside: avoid;
        }
        .card-header {
            background-color: #f8f9fa !important;
            color: #212529 !important;
        }
    }
    
    .prediction-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .prediction-header {
        padding: 20px;
        color: white;
    }
    .risk-high {
        background-color: #dc3545;
    }
    .risk-medium {
        background-color: #fd7e14;
    }
    .risk-low {
        background-color: #28a745;
    }
    .feature-contribution {
        margin-bottom: 12px;
    }
    .contribution-bar {
        height: 20px;
        border-radius: 4px;
    }
    .positive-contrib {
        background-color: #28a745;
    }
    .negative-contrib {
        background-color: #dc3545;
    }
    .patient-info-table th {
        width: 40%;
    }
    .recommendation-box {
        border-left: 5px solid;
        padding: 15px;
        margin-bottom: 20px;
    }
    .border-danger {
        border-color: #dc3545;
    }
    .border-warning {
        border-color: #fd7e14;
    }
    .border-success {
        border-color: #28a745;
    }
    .shap-summary-plot {
        text-align: center;
        margin: 20px auto;
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .feature-value {
        font-size: 0.85em;
        color: #6c757d;
    }
    .print-hide {
        display: initial;
    }
    @media print {
        .print-hide {
            display: none !important;
        }
        .container {
            width: 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4 print-hide">
            <h2><i class="fas fa-file-medical-alt me-2"></i>Appendicitis Diagnosis Results</h2>
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Report
                </button>
                <a href="{{ url_for('diagnose') }}" class="btn btn-primary">
                    <i class="fas fa-redo me-2"></i>New Diagnosis
                </a>
            </div>
        </div>

        <!-- Timestamp and ID -->
        <div class="alert alert-light mb-4">
            <div class="row">
                <div class="col-md-6">
                    <strong>Assessment Time:</strong> {{ timestamp }}
                </div>
                <div class="col-md-6 text-md-end">
                    <strong>Report ID:</strong> {{ report_id }}
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Prediction Result -->
            <div class="col-lg-6 mb-4">
                <div class="card prediction-card h-100">
                    <div class="prediction-header {% if results.prediction_class == 'High' %}risk-high{% elif results.prediction_class == 'Medium' %}risk-medium{% else %}risk-low{% endif %}">
                        <h3 class="card-title mb-0">
                            {% if results.prediction_class == 'High' %}
                                <i class="fas fa-exclamation-triangle me-2"></i>
                            {% elif results.prediction_class == 'Medium' %}
                                <i class="fas fa-exclamation-circle me-2"></i>
                            {% else %}
                                <i class="fas fa-check-circle me-2"></i>
                            {% endif %}
                            {{ results.prediction_class }} Risk of Appendicitis
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="display-4 fw-bold">{{ results.probability }}%</div>
                            <p class="text-muted">Predicted Probability</p>
                        </div>
                        
                        <div class="progress mb-4" style="height: 30px;">
                            <div class="progress-bar bg-danger" role="progressbar" data-progress-value="{{ results.probability }}" style="width: 0%">
                                {{ results.probability }}%
                            </div>
                        </div>
                        
                        <div class="recommendation-box {% if results.prediction_class == 'High' %}border-danger{% elif results.prediction_class == 'Medium' %}border-warning{% else %}border-success{% endif %}">
                            <h5>Recommendation:</h5>
                            <p>
                                {% if results.prediction_class == 'High' %}
                                    Strong suspicion of appendicitis. Surgical consultation recommended. Consider immediate intervention.
                                {% elif results.prediction_class == 'Medium' %}
                                    Moderate suspicion of appendicitis. Close observation advised. Consider additional imaging if not already performed.
                                {% else %}
                                    Low suspicion of appendicitis. Consider alternative diagnoses and monitoring if symptoms persist.
                                {% endif %}
                            </p>
                        </div>

                        <div class="alert alert-warning mb-0">
                            <small class="text-muted">
                                <strong>Note:</strong> This tool provides decision support only. Clinical judgment should always prevail.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Information Summary -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-user me-2"></i>Patient Information</h5>
                    </div>
                    <div class="card-body">
                        <h6>Demographics</h6>
                        <table class="table table-sm table-striped patient-info-table mb-3">
                            <tbody>
                                <tr>
                                    <th>Age</th>
                                    <td>{{ form_data.get('age', 'N/A') }} years</td>
                                </tr>
                                <tr>
                                    <th>Gender</th>
                                    <td>{{ form_data.get('gender', 'N/A')|capitalize }}</td>
                                </tr>
                                {% if form_data.get('weight') and form_data.get('height') %}
                                <tr>
                                    <th>Weight/Height</th>
                                    <td>{{ form_data.get('weight', 'N/A') }} kg / {{ form_data.get('height', 'N/A') }} cm</td>
                                </tr>
                                <tr>
                                    <th>BMI</th>
                                    <td>{{ form_data.get('bmi', 'N/A') }} kg/m²</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>

                        <h6>Clinical Features</h6>
                        <table class="table table-sm table-striped patient-info-table mb-3">
                            <tbody>
                                <tr>
                                    <th>Duration of Pain</th>
                                    <td>{{ form_data.get('duration', 'N/A') }} hours</td>
                                </tr>
                                <tr>
                                    <th>Pain Migration to RLQ</th>
                                    <td>{{ 'Yes' if form_data.get('migration') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Right Lower Quadrant Pain</th>
                                    <td>{{ 'Yes' if form_data.get('right_lower_quadrant_pain') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Rebound Tenderness</th>
                                    <td>{{ 'Yes' if form_data.get('rebound_tenderness') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Anorexia</th>
                                    <td>{{ 'Yes' if form_data.get('anorexia') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Nausea</th>
                                    <td>{{ 'Yes' if form_data.get('nausea') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Vomiting</th>
                                    <td>{{ 'Yes' if form_data.get('vomiting') else 'No' }}</td>
                                </tr>
                                <tr>
                                    <th>Fever (>38°C)</th>
                                    <td>{{ 'Yes' if form_data.get('fever') else 'No' }}</td>
                                </tr>
                            </tbody>
                        </table>

                        <h6>Laboratory Values</h6>
                        <table class="table table-sm table-striped patient-info-table">
                            <tbody>
                                <tr>
                                    <th>White Blood Cell Count</th>
                                    <td>{{ form_data.get('white_blood_cell_count', 'N/A') }} ×10³/μL</td>
                                </tr>
                                <tr>
                                    <th>Neutrophil Percentage</th>
                                    <td>{{ form_data.get('neutrophil_percentage', 'N/A') }}%</td>
                                </tr>
                                <tr>
                                    <th>C-Reactive Protein</th>
                                    <td>{{ form_data.get('c_reactive_protein', 'N/A') }} mg/L</td>
                                </tr>
                                {% if form_data.get('ultrasound_performed') == 'yes' %}
                                <tr>
                                    <th>Ultrasound Finding</th>
                                    <td>
                                        {% if form_data.get('ultrasound_result') == 'positive' %}
                                            Positive for appendicitis
                                        {% elif form_data.get('ultrasound_result') == 'negative' %}
                                            Negative for appendicitis
                                        {% elif form_data.get('ultrasound_result') == 'equivocal' %}
                                            Equivocal/Inconclusive
                                        {% else %}
                                            {{ form_data.get('ultrasound_result', 'N/A') }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explanation Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Feature Importance Explanation (SHAP Analysis)</h5>
            </div>
            <div class="card-body">
                <p class="card-text">This section shows how each clinical factor contributed to the prediction. Positive values (green) increase the likelihood of appendicitis, while negative values (red) decrease it.</p>
                
                {% if shap_image %}
                <div class="row mb-4">
                    <div class="col-lg-10 mx-auto">
                        <div class="shap-summary-plot">
                            <h6 class="text-center mb-3">SHAP Summary Plot</h6>
                            <img src="data:image/png;base64,{{ shap_image }}" class="img-fluid" alt="SHAP Summary Plot">
                            <p class="mt-2 text-muted small">This plot shows how each feature impacts the model prediction. Features are ordered by importance (top = most important).</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if waterfall_image %}
                <div class="row mb-4">
                    <div class="col-lg-10 mx-auto">
                        <div class="waterfall-plot">
                            <h6 class="text-center mb-3">Feature Contributions Waterfall Chart</h6>
                            <img src="data:image/png;base64,{{ waterfall_image }}" class="img-fluid" alt="Feature Contributions Waterfall Chart">
                            <p class="mt-2 text-muted small">This waterfall chart shows how each feature moves the prediction from the base value to the final prediction probability. Green bars increase probability, red bars decrease it.</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <h6 class="mb-3">Feature Contributions to Prediction</h6>
                        
                        {% if base_value_results %}
                        <div class="alert alert-info mb-3">
                            <div class="d-flex justify-content-between">
                                <span><strong>Base value (expected probability):</strong></span>
                                <span>{{ base_value_results.formatted_base_value }}</span>
                            </div>
                            <div class="small text-muted">
                                This is the average model output over the training dataset. Feature contributions show how each input value pushes the prediction from this baseline.
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if shap_values %}
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <span><strong>Note:</strong> SHAP values are calculated on transformed data. The model transforms your input data before making predictions.</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if shap_values %}
                            {% for feature in shap_values %}
                            <div class="feature-contribution">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div>
                                        <span class="feature-name">{{ feature.name }}</span>
                                        <span class="feature-value">({{ feature.display_value }})</span>
                                        {% if feature.transformed_value != 'N/A' %}
                                        <span class="feature-transformed text-muted small">
                                            <i class="fas fa-arrow-right mx-1"></i>Transformed: {{ feature.transformed_value }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="contribution-value {% if feature.is_positive %}text-success{% else %}text-danger{% endif %}">
                                            {% if feature.is_positive %}+{% endif %}{{ "%.4f"|format(feature.value) }}
                                        </span>
                                    </div>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    {% if feature.is_positive %}
                                    <div class="progress-bar positive-contrib" role="progressbar" data-progress-value="{{ feature.value_percent }}" style="width: 0%"></div>
                                    {% else %}
                                    <div class="progress-bar negative-contrib" role="progressbar" data-progress-value="{{ feature.value_percent }}" style="width: 0%"></div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                Feature contribution data is not available for this prediction.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="text-center mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-secondary">
                                <h6>Understanding SHAP Values</h6>
                                <p class="small mb-0">
                                    SHAP (SHapley Additive exPlanations) values show how each feature contributes to pushing the prediction away from the baseline ({{ base_value_results.formatted_base_value }}) toward the final prediction ({{ results.probability }}%).
                                    <strong>Green bars (positive values)</strong> increase the probability of appendicitis, while
                                    <strong>red bars (negative values)</strong> decrease it. Longer bars indicate stronger impact.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Notes -->
        <div class="card mb-4">
            <div class="card-body">
                <h6>Pediatric Appendicitis Diagnosis Support Tool</h6>
                <p class="small text-muted mb-0">
                    This diagnostic support tool uses machine learning to assist pediatricians in assessing the likelihood of appendicitis.
                    The model was trained on the Regensburg pediatric appendicitis dataset. The analysis considers demographic information,
                    clinical symptoms, and laboratory findings. SHAP (SHapley Additive exPlanations) technology is used to provide transparent
                    explanations of the machine learning predictions. This tool is intended for clinical decision support only and should not
                    replace clinical judgment.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Add any additional JavaScript here
    document.addEventListener('DOMContentLoaded', function() {
        // You can add interactive elements here if needed
        console.log('Results page loaded');
        
        // Set the progress bar widths properly to avoid CSS linting issues
        document.querySelectorAll('[data-progress-value]').forEach(function(bar) {
            const progressValue = bar.getAttribute('data-progress-value');
            // Set a small delay to allow for smooth animation
            setTimeout(function() {
                bar.style.width = (progressValue || 0) + '%';
            }, 100);
        });
    });
</script>
{% endblock %}
